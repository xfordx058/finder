
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ü•§ Milk Tea Finder</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
   <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="app-container">
      <div id="header">
        <h1>ü•§ Milk Tea Finder</h1>
        <button id="saved-list-btn" class="btn" onclick="showSavedPlaces()">
          ‚ù§Ô∏è Saved
        </button>
      </div>

      <div id="content-area">
        <div id="map"></div>
        <div id="cards-feed">
          <p style="text-align: center; color: #777;">Click "Find Milk Tea Near Me" to see shops here!</p>
        </div>
      </div>

      <div id="panel">
        <button class="btn" onclick="findMilkTea()">üìç Find Milk Tea Near Me</button>
        <button class="btn" id="clear-results-btn" onclick="clearAllResults()">üóëÔ∏è Clear</button>
      </div>
    </div>

    <script>
      let map, service, infoWindow;
      let markers = {}; // Store markers by place_id for easy lookup
      let fetchedPlacesDetails = {}; // Cache for place details
      let userCurrentLocation = null; // Store user's current location for directions

      const DEFAULT_CENTER = { lat: 14.5995, lng: 120.9842 }; // Manila default
      // Fallback image if a shop has no photo
      const NO_PHOTO_URL = 'https://via.placeholder.com/150x120/f0f0f0/999999?text=No+Photo'; 

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: DEFAULT_CENTER,
          zoom: 14,
        });
        infoWindow = new google.maps.InfoWindow();
        service = new google.maps.places.PlacesService(map);
      }

      function findMilkTea() {
        clearAllResults(); 

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userCurrentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };

              map.setCenter(userCurrentLocation);
              map.setZoom(15);

              // User location marker
              new google.maps.Marker({
                position: userCurrentLocation,
                map: map,
                title: 'You are here',
                icon: {
                  url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png', // Blue dot for user
                  scaledSize: new google.maps.Size(40, 40),
                },
              });

              const request = {
                location: userCurrentLocation,
                radius: 3000,
                keyword: 'milk tea',
              };

              service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                  document.getElementById('cards-feed').innerHTML = ''; 

                  results.forEach(place => {
                    // Create marker first
                    createMarker(place); 
                    
                    // Then fetch details to populate the card and info window
                    service.getDetails({ placeId: place.place_id, fields: ['name', 'formatted_address', 'formatted_phone_number', 'geometry', 'rating', 'user_ratings_total', 'opening_hours', 'url', 'place_id', 'photos'] }, (details, detailStatus) => {
                        if (detailStatus === google.maps.places.PlacesServiceStatus.OK) {
                            fetchedPlacesDetails[place.place_id] = details; // Cache details
                            createShopCard(details);
                        } else {
                            // Fallback for card if details fail (use basic info from nearbySearch)
                            createShopCard(place); 
                            console.error('Details request failed for card:', detailStatus, place.name);
                        }
                    });
                  });

                  if (results.length === 0) {
                      document.getElementById('cards-feed').innerHTML = '<p style="text-align: center; color: #777;">No Milk Tea spots found within 3km.</p>';
                  }
                } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                    document.getElementById('cards-feed').innerHTML = '<p style="text-align: center; color: #777;">No Milk Tea spots found within 3km.</p>';
                } else {
                    alert('Error finding milk tea shops: ' + status);
                    console.error('Places service failed:', status);
                }
              });
            },
            (error) => {
              alert('Geolocation failed: ' + error.message);
              map.setCenter(DEFAULT_CENTER);
            }
          );
        } else {
          alert('Geolocation not supported by this browser.');
        }
      }

      function createMarker(place) {
        if (!place.geometry || !place.geometry.location) return;

        const bobaIcon = {
            url: "data:image/svg+xml;charset=UTF-8,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='12' cy='12' r='10' fill='%23795548'/%3E%3Ccircle cx='12' cy='12' r='4' fill='%23FFC107'/%3E%3Cpath d='M10 14L14 10' stroke='white' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E",
            scaledSize: new google.maps.Size(35, 35),
            anchor: new google.maps.Point(17, 35)
        };

        const marker = new google.maps.Marker({
          map,
          position: place.geometry.location,
          title: place.name,
          icon: bobaIcon,
          placeId: place.place_id 
        });

        markers[place.place_id] = marker; // Store marker by place_id
        
        google.maps.event.addListener(marker, 'click', () => {
            const details = fetchedPlacesDetails[place.place_id];
            if (details) {
                const htmlContent = buildInfoContent(details);
                infoWindow.setContent(htmlContent);
            } else {
                infoWindow.setContent(`<div class="info-content"><h4>${place.name}</h4><p>Loading details...</p></div>`);
                // If for some reason details aren't cached, try fetching again
                service.getDetails({ placeId: place.place_id, fields: ['name', 'formatted_address', 'formatted_phone_number', 'geometry', 'rating', 'user_ratings_total', 'opening_hours', 'url', 'place_id', 'photos'] }, (re_details, re_status) => {
                    if (re_status === google.maps.places.PlacesServiceStatus.OK) {
                        fetchedPlacesDetails[place.place_id] = re_details;
                        infoWindow.setContent(buildInfoContent(re_details));
                    }
                });
            }
            infoWindow.open(map, marker);
            map.setCenter(marker.getPosition()); 
        });
      }

      function createShopCard(details) {
        const cardsFeed = document.getElementById('cards-feed');
        const card = document.createElement('a'); // Changed to <a> for better semantics
        card.className = 'shop-card';
        card.setAttribute('data-place-id', details.place_id);
        // Prevent default navigation for <a> tag, handle click with JS
        card.href = '#'; 

        const rating = details.rating ? `<span class="rating">${details.rating} ‚≠ê</span> (${details.user_ratings_total || 0})` : 'No rating';
        const address = details.vicinity || details.formatted_address || 'Address unavailable';
        const statusText = details.opening_hours && details.opening_hours.open_now !== undefined
          ? `<span class="status ${details.opening_hours.open_now ? 'status-open' : 'status-closed'}">${details.opening_hours.open_now ? 'Open Now' : 'Closed'}</span>`
          : 'Status unknown';

        const sanitizedName = details.name.replace(/'/g, "\\'"); 
        
        let savedPlaces = getSavedPlaces();
        const isPlaceSaved = savedPlaces.hasOwnProperty(details.place_id);

        // --- NEW: Shop Image handling ---
        let photoUrl = NO_PHOTO_URL;
        if (details.photos && details.photos.length > 0) {
            // Get URL for a photo with max width 400px
            photoUrl = details.photos[0].getUrl({ maxWidth: 400 }); 
        }

        card.innerHTML = `
          <img src="${photoUrl}" alt="${details.name} shop front" class="shop-image ${photoUrl === NO_PHOTO_URL ? 'no-photo' : ''}">
          <h3>${details.name}</h3>
          <p>${address}</p>
          <p>${rating} ‚Ä¢ ${statusText}</p>
          <div class="action-buttons">
              <button 
                  id="save-btn-${details.place_id}" 
                  class="save-btn ${isPlaceSaved ? 'saved' : ''}" 
                  onclick="event.stopPropagation(); toggleSaved('${details.place_id}', '${sanitizedName}')">
                  ${isPlaceSaved ? 'üåü Saved!' : '‚≠ê Save'}
              </button>
              <a class="direction-link" 
                 href="${getDirectionsUrl(details.place_id, details.name, details.formatted_address)}" 
                 target="_blank" 
                 onclick="event.stopPropagation();">
                  üó∫Ô∏è Get Directions
              </a>
          </div>
        `;

        card.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent default <a> tag behavior
            const placeId = card.getAttribute('data-place-id');
            const marker = markers[placeId];
            if (marker) {
                google.maps.event.trigger(marker, 'click'); 
            }
        });

        cardsFeed.appendChild(card);
      }
      
      // Re-use buildInfoContent for map info window
      function buildInfoContent(details) {
        const rating = details.rating ? `<p>Rating: <strong>${details.rating} ‚≠ê</strong> (${details.user_ratings_total} reviews)</p>` : '';
        const address = details.formatted_address ? `<p>${details.formatted_address}</p>` : '';
        const phone = details.formatted_phone_number ? `<p>Call: ${details.formatted_phone_number}</p>` : '';
        const status = details.opening_hours 
          ? `<p>Status: <span class="${details.opening_hours.open_now ? 'status-open' : 'status-closed'}">${details.opening_hours.open_now ? 'Open Now' : 'Closed'}</span></p>`
          : '';
        const mapLink = details.url ? `<a class="view-map-link" href="${details.url}" target="_blank">View on Google Maps</a>` : '';
        
        const sanitizedName = details.name.replace(/'/g, "\\'"); 
        
        let savedPlaces = getSavedPlaces();
        const isPlaceSaved = savedPlaces.hasOwnProperty(details.place_id);

        const saveButtonHtml = `
            <button 
                id="save-btn-${details.place_id}" 
                class="save-btn ${isPlaceSaved ? 'saved' : ''}" 
                onclick="toggleSaved('${details.place_id}', '${sanitizedName}')">
                ${isPlaceSaved ? 'üåü Saved!' : '‚≠ê Save'}
            </button>
        `;

        const directionsLinkHtml = `
            <a class="direction-link" 
               href="${getDirectionsUrl(details.place_id, details.name, details.formatted_address)}" 
               target="_blank">
                üó∫Ô∏è Get Directions
            </a>
        `;
        
        return `
          <div class="info-content">
            <h4>${details.name}</h4>
            ${status}
            ${rating}
            ${address}
            ${phone}
            ${mapLink}
            <div class="action-buttons">
                ${saveButtonHtml}
                ${directionsLinkHtml}
            </div>
          </div>
        `;
      }
      
      // --- LOCAL STORAGE FUNCTIONS (Saved Features) ---
      
      function getSavedPlaces() {
          const saved = localStorage.getItem('milkteaFinderSaved');
          return saved ? JSON.parse(saved) : {}; 
      }

      function toggleSaved(placeId, placeName) {
          let savedPlaces = getSavedPlaces();
          
          // Update the button on the card if it exists
          const cardSaveButton = document.querySelector(`.shop-card[data-place-id="${placeId}"] .save-btn`);
          // Update the button in the info window if it's open
          const infoWindowSaveButton = document.getElementById(`save-btn-${placeId}`);

          if (savedPlaces.hasOwnProperty(placeId)) {
              delete savedPlaces[placeId];
              if (cardSaveButton) {
                cardSaveButton.textContent = '‚≠ê Save';
                cardSaveButton.classList.remove('saved');
              }
              if (infoWindowSaveButton) { 
                infoWindowSaveButton.textContent = '‚≠ê Save';
                infoWindowSaveButton.classList.remove('saved');
              }
              console.log(`Unsaved: ${placeName}`);
          } else {
              savedPlaces[placeId] = placeName;
              if (cardSaveButton) {
                cardSaveButton.textContent = 'üåü Saved!';
                cardSaveButton.classList.add('saved');
              }
              if (infoWindowSaveButton) { 
                infoWindowSaveButton.textContent = 'üåü Saved!';
                infoWindowSaveButton.classList.add('saved');
              }
              console.log(`Saved: ${placeName}`);
          }
          
          localStorage.setItem('milkteaFinderSaved', JSON.stringify(savedPlaces));
      }
      
      function showSavedPlaces() {
          const savedPlaces = getSavedPlaces();
          const placeIds = Object.keys(savedPlaces);
          
          if (placeIds.length === 0) {
              alert("You haven't saved any milk tea shops yet!");
              return;
          }
          
          let list = "Your Favorite Milk Tea Shops:\n\n";
          placeIds.forEach(id => {
              const name = savedPlaces[id];
              list += `‚Ä¢ ${name}\n`;
          });
          
          alert(list);
      }
      // --- END LOCAL STORAGE FUNCTIONS ---

      // --- DIRECTIONS FUNCTION ---
      function getDirectionsUrl(placeId, placeName, formattedAddress) {
          const origin = userCurrentLocation 
            ? `${userCurrentLocation.lat},${userCurrentLocation.lng}` 
            : 'Current+Location'; 
            
          const destination = placeId 
            ? `place_id:${placeId}` 
            : encodeURIComponent(formattedAddress || placeName);

          return `http://maps.google.com/maps/dir/${origin}/${destination}&travelmode=driving`;
      }

      function clearAllResults() {
          for (const placeId in markers) {
              markers[placeId].setMap(null);
          }
          markers = {};
          fetchedPlacesDetails = {}; 
          if (infoWindow) {
              infoWindow.close();
          }
          document.getElementById('cards-feed').innerHTML = '<p style="text-align: center; color: #777;">Click "Find Milk Tea Near Me" to see shops here!</p>';
          
          map.setCenter(DEFAULT_CENTER); 
          map.setZoom(14);
          userCurrentLocation = null; // Clear user location
      }
    </script>

    <script
      async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDk8cpELLpGngE-1uLEGSuG5VnUwTqPq3w&libraries=places&callback=initMap"
    ></script>
  </body>
</html>


