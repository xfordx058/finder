<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Milktea Maven â€” Pastel Swipe</title>
Â  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%F0%9F%A7%8B%3C/text%3E%3C/svg%3E">
Â  <!-- Hammer.js for swipe gestures -->
Â  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Merged CSS for single-file mandate -->
  <style>
    /* 1. Variables and Base Styles */
    :root {
        --color-primary: #A3C9A8; /* Soft Green */
        --color-secondary: #E2F0D9; /* Light Cream */
        --color-accent: #DDC8BE; /* Soft Brown */
        --color-danger: #E57373; /* Light Red */
        --color-text: #333;
    }
    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--color-secondary);
        color: var(--color-text);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 20px;
    }
    .app {
        width: 100%;
        max-width: 450px;
        padding: 0 16px;
    }
    
    /* 2. Header and Controls */
    .top {
        text-align: center;
        margin-bottom: 24px;
    }
    .logo {
        font-size: 2.5rem;
        font-weight: 800;
        color: #709475;
        margin-bottom: 4px;
        margin-top: 0;
    }
    .subtitle {
        font-size: 0.9rem;
        color: #555;
        margin-top: 0;
        margin-bottom: 12px;
    }
    .controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
    }
    .btn {
        padding: 8px 16px;
        border-radius: 9999px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        font-size: 0.875rem;
    }
    .btn-primary {
        background-color: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }
    .btn-primary:hover {
        background-color: #8bb190;
    }
    .btn-soft {
        background-color: var(--color-accent);
        color: white;
        border-color: var(--color-accent);
    }
    .btn-soft:hover {
        background-color: #c7b3a7;
    }
    .btn-ghost {
        background-color: transparent;
        color: #709475;
        border-color: #c0d8c3;
    }
    .btn-ghost:hover {
        background-color: #eaf1eb;
    }
    .btn-danger {
        background-color: var(--color-danger);
        color: white;
        border-color: var(--color-danger);
    }

    /* 3. Card Area (Swiping) */
    .card-area {
        position: relative;
        height: 350px;
        margin-bottom: 80px; /* Space for action buttons */
    }
    .cards-stack {
        position: relative;
        height: 100%;
        display: flex;
        justify-content: center;
    }
    .card-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: grab;
        transform-origin: 50% 100%;
        transition: transform 300ms cubic-bezier(0.25, 0.8, 0.5, 1);
        touch-action: none;
    }
    .card {
        background-color: white;
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        border: 1px solid #eee;
    }
    .card-media {
        height: 60%;
        overflow: hidden;
        border-bottom: 1px solid #f0f0f0;
    }
    .card-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .card-body {
        padding: 12px 16px;
        height: 40%;
    }
    .card-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #444;
        margin: 0 0 4px 0;
    }
    .card-sub {
        font-size: 0.85rem;
        color: #777;
        margin-bottom: 8px;
    }
    .card-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        font-weight: 600;
    }
    .empty-note {
        text-align: center;
        padding-top: 100px;
        color: #888;
    }

    /* 4. Action Buttons */
    .actions {
        position: absolute;
        bottom: -70px; /* Position below the cards */
        width: 100%;
        display: flex;
        justify-content: space-around;
        padding: 0 40px;
    }
    .round-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        font-size: 1.5rem;
        font-weight: 800;
        border: none;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .reject {
        background-color: var(--color-danger);
        color: white;
    }
    .like {
        background-color: var(--color-primary);
        color: white;
    }
    .round-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    /* 5. Map Preview */
    .map-preview {
        width: 100%;
        margin-top: 30px;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        background-color: white;
    }
    .map {
        height: 200px;
        width: 100%;
    }
    .map-footer {
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #eee;
    }
    .map-status {
        font-size: 0.85rem;
        color: #555;
        font-weight: 600;
    }
    .map-actions {
        display: flex;
        gap: 8px;
    }
    .btn-map {
        padding: 6px 10px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #ccc;
        background-color: #f8f8f8;
        font-size: 0.8rem;
        color: #444;
    }
    .btn-map:hover {
        background-color: #e0e0e0;
    }

    /* 6. Modal and Saved List */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal.hidden {
        display: none;
    }
    .modal-card {
        background-color: white;
        border-radius: 1rem;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #709475;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #888;
    }
    .saved-list {
        overflow-y: auto;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .saved-row {
        display: flex;
        align-items: center;
        background-color: var(--color-secondary);
        padding: 8px;
        border-radius: 8px;
    }
    .saved-row img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 10px;
    }
    .saved-meta {
        flex-grow: 1;
    }
    .saved-title {
        font-weight: 600;
        font-size: 1rem;
    }
    .saved-sub {
        font-size: 0.75rem;
        color: #666;
    }
    .saved-actions {
        display: flex;
        gap: 4px;
    }
    .saved-actions .btn {
        padding: 4px 8px;
        font-size: 0.75rem;
    }
    .modal-foot {
        margin-top: 15px;
        text-align: center;
    }

    /* 7. Loader and Toast */
    .loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        z-index: 1001;
    }
    .loader.hidden { display: none; }
    .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(51, 51, 51, 0.9);
        color: white;
        padding: 10px 20px;
        border-radius: 9999px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 1002;
        transition: opacity 0.3s;
    }
    .toast.hidden { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
Â  <main class="app">
Â  Â  <header class="top">
Â  Â  Â  <div>
Â  Â  Â  Â  <h1 class="logo">Milktea Maven ğŸ§‹</h1>
Â  Â  Â  Â  <p class="subtitle">Swipe right to save your next boba fix â€” modern pastel vibes.</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <button id="btn-find" class="btn btn-primary">Find Boba Near Me</button>
Â  Â  Â  Â  <button id="btn-saved" class="btn btn-soft">Show Saved</button>
Â  Â  Â  Â  <button id="btn-test" class="btn btn-ghost">Test with Catarman (UEP)</button>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <section class="card-area">
Â  Â  Â  <div id="cards" class="cards-stack">
Â  Â  Â  Â  <div class="empty-note">No results yet â€” click "Find Boba Near Me" to begin.</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions">
Â  Â  Â  Â  <button id="btn-reject" class="round-btn reject">âœ•</button>
Â  Â  Â  Â  <button id="btn-like" class="round-btn like">â¤</button>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  <section class="map-preview" id="mapPreviewWrap">
Â  Â  Â  <div id="map" class="map"></div>
Â  Â  Â  <div class="map-footer">
Â  Â  Â  Â  <div id="mapStatus" class="map-status">Loading map...</div>
Â  Â  Â  Â  <div class="map-actions">
Â  Â  Â  Â  Â  <button id="btn-open-google" class="btn btn-map">Open in Google Maps</button>
Â  Â  Â  Â  Â  <button id="btn-clear-saved" class="btn btn-soft">Clear All Saved</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>


Â  Â  <!-- Saved modal -->
Â  Â  <div id="savedModal" class="modal hidden">
Â  Â  Â  <div class="modal-card">
Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  <h3>Saved Milktea Shops</h3>
Â  Â  Â  Â  Â  <button id="savedClose" class="modal-close">âœ•</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="savedList" class="saved-list"></div>
Â  Â  Â  Â  <div class="modal-foot">
Â  Â  Â  Â  Â  <button id="savedClear" class="btn btn-danger">Clear all saved</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Lightweight loader -->
Â  Â  <div id="loader" class="loader hidden">Searchingâ€¦</div>

Â  Â  <!-- Toast -->
Â  Â  <div id="toast" class="toast hidden"></div>
Â  </main>

Â  <script>
Â  Â  /*************************************************
Â  Â  Â * Milktea Maven: Index (HTML + JS)
Â  Â  Â *************************************************/

Â  Â  // App config
Â  Â  const PHOTO_MAX_WIDTH = 600;Â  Â  Â  // Place photo width
Â  Â  const SEARCH_RADIUS = 5000;Â  Â  Â  Â // meters
Â  Â  const LOCAL_STORAGE_KEY = 'milktea_maven_saved_v1';

Â  Â  // State
Â  Â  let map, userMarker, savedMarkers = [];
Â  Â  let currentResults = []; // array of place objects (Places API)
Â  Â  let currentPlaceFocused = null;

Â  Â  // DOM
Â  Â  const cardsWrap = document.getElementById('cards');
Â  Â  const btnFind = document.getElementById('btn-find');
Â  Â  const btnSaved = document.getElementById('btn-saved');
Â  Â  const btnTest = document.getElementById('btn-test');
Â  Â  const btnLike = document.getElementById('btn-like');
Â  Â  const btnReject = document.getElementById('btn-reject');
Â  Â  const loader = document.getElementById('loader');
Â  Â  const toast = document.getElementById('toast');
Â  Â  const savedModal = document.getElementById('savedModal');
Â  Â  const savedList = document.getElementById('savedList');
Â  Â  const savedClose = document.getElementById('savedClose');
Â  Â  const savedClear = document.getElementById('savedClear');
Â  Â  const btnOpenGoogle = document.getElementById('btn-open-google');
Â  Â  const mapStatus = document.getElementById('mapStatus');
Â  Â  const btnClearSaved = document.getElementById('btn-clear-saved');

Â  Â  // Helpers: localStorage saved shops
Â  Â  function getSaved() {
Â  Â  Â  try {
Â  Â  Â  Â  return JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
Â  Â  Â  } catch(e) { return []; }
Â  Â  }
Â  Â  function setSaved(list) {
Â  Â  Â  localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(list));
Â  Â  }
Â  Â  function addSaved(place) {
Â  Â  Â  const saved = getSaved();
Â  Â  Â  if (!saved.some(s => s.place_id === place.place_id)) {
Â  Â  Â  Â  saved.push(place);
Â  Â  Â  Â  setSaved(saved);
Â  Â  Â  Â  showToast(`Saved: ${place.name}`);
Â  Â  Â  Â  renderSavedList();
Â  Â  Â  Â  renderSavedMarkers();
Â  Â  Â  } else showToast(`${place.name} is already saved`);
Â  Â  }
Â  Â  function removeSaved(place_id) {
Â  Â  Â  const saved = getSaved().filter(s => s.place_id !== place_id);
Â  Â  Â  setSaved(saved);
Â  Â  Â  renderSavedList();
Â  Â  Â  renderSavedMarkers();
Â  Â  Â  showToast('Removed saved shop');
Â  Â  }
Â  Â  function clearSavedAll() {
Â  Â  Â  setSaved([]);
Â  Â  Â  renderSavedList();
Â  Â  Â  renderSavedMarkers();
Â  Â  Â  showToast('All saved shops cleared');
Â  Â  }

Â  Â  // UI helpers
Â  Â  function showLoader(yes=true) { loader.classList.toggle('hidden', !yes); }
Â  Â  function showToast(msg, ms=2000) {
Â  Â  Â  toast.textContent = msg;
Â  Â  Â  toast.classList.remove('hidden');
Â  Â  Â  setTimeout(()=> toast.classList.add('hidden'), ms);
Â  Â  }

Â  Â  // Card creation & swipe
Â  Â  function createCard(place, index) {
Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  wrapper.className = 'card-wrapper';
Â  Â  Â  wrapper.style.zIndex = 100 - index;

Â  Â  Â  const card = document.createElement('article');
Â  Â  Â  card.className = 'card';

Â  Â  Â  // image url - use place.photos (client-side Places Library supplies getUrl)
Â  Â  Â  let imgUrl = 'https://placehold.co/800x400/DDC8BE/ffffff?text=Milktea';
Â  Â  Â  if (place.photos && place.photos.length) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  imgUrl = place.photos[0].getUrl({maxWidth: PHOTO_MAX_WIDTH});
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  // fallback already set
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  <div class="card-media">
Â  Â  Â  Â  Â  <img src="${imgUrl}" alt="${escapeHtml(place.name)}" loading="lazy" onerror="this.onerror=null; this.src='https://placehold.co/800x400/DDC8BE/ffffff?text=Milktea';"/>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  <h3 class="card-title">${escapeHtml(place.name)}</h3>
Â  Â  Â  Â  Â  <p class="card-sub">${escapeHtml(place.vicinity || place.formatted_address || '')}</p>
Â  Â  Â  Â  Â  <div class="card-meta">
Â  Â  Â  Â  Â  Â  <span class="rating">â­ ${place.rating || 'â€“'}</span>
Â  Â  Â  Â  Â  Â  <span class="distance" id="d-${place.place_id}"></span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  wrapper.appendChild(card);
Â  Â  Â  setupHammer(wrapper, place);
Â  Â  Â  return wrapper;
Â  Â  }

Â  Â  // Attach Hammer swipe listeners to wrapper
Â  Â  function setupHammer(wrapper, place) {
Â  Â  Â  const hammertime = new Hammer(wrapper);
Â  Â  Â  const card = wrapper.querySelector('.card');
Â  Â  Â  
Â  Â  Â  // Pan/Drag listener for interactive movement
Â  Â  Â  hammertime.get('pan').set({ direction: Hammer.DIRECTION_HORIZONTAL, threshold: 5 });

Â  Â  Â  hammertime.on('pan', (ev) => {
Â  Â  Â  Â  card.style.transition = 'none';
Â  Â  Â  Â  const dx = ev.deltaX;
Â  Â  Â  Â  const rot = dx / 20;
Â  Â  Â  Â  card.style.transform = `translateX(${dx}px) rotate(${rot}deg)`;
Â  Â  Â  });

Â  Â  Â  hammertime.on('panend', (ev) => {
Â  Â  Â  Â  card.style.transition = 'transform 300ms ease';
Â  Â  Â  Â  const dx = ev.deltaX;
Â  Â  Â  Â  if (dx > 120) { // like (swipe right)
Â  Â  Â  Â  Â  card.style.transform = `translateX(150%) rotate(15deg)`;
Â  Â  Â  Â  Â  setTimeout(()=> {
Â  Â  Â  Â  Â  Â  wrapper.remove();
Â  Â  Â  Â  Â  Â  addSaved(serializePlaceForSaving(place));
Â  Â  Â  Â  Â  Â  rearrangeStack();
Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  } else if (dx < -120) { // reject (swipe left)
Â  Â  Â  Â  Â  card.style.transform = `translateX(-150%) rotate(-15deg)`;
Â  Â  Â  Â  Â  setTimeout(()=> {
Â  Â  Â  Â  Â  Â  wrapper.remove();
Â  Â  Â  Â  Â  Â  rearrangeStack();
Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  card.style.transform = '';
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // click to focus (center map preview)
Â  Â  Â  wrapper.addEventListener('click', (e) => {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  currentPlaceFocused = place;
Â  Â  Â  Â  centerMapToPlace(place);
Â  Â  Â  });
Â  Â  }

Â  Â  function rearrangeStack() {
Â  Â  Â  // minor restyle of remaining stack to look nice
Â  Â  Â  const wrappers = document.querySelectorAll('.card-wrapper');
Â  Â  Â  wrappers.forEach((w,i) => {
Â  Â  Â  Â  w.style.zIndex = 100 - i;
Â  Â  Â  Â  const c = w.querySelector('.card');
Â  Â  Â  Â  c.style.transform = `scale(${1 - i*0.03}) translateY(${i*8}px)`;
Â  Â  Â  });
Â  Â  Â  if (!wrappers.length) {
Â  Â  Â  Â  cardsWrap.innerHTML = '<div class="empty-note">No more results. Try searching again.</div>';
Â  Â  Â  }
Â  Â  }

Â  Â  // Small helper to serialize minimal place data for saved list & persistence
Â  Â  function serializePlaceForSaving(place) {
Â  Â  Â  // place.photos[0].getUrl returns a URL usable from client.
Â  Â  Â  const photo = (place.photos && place.photos.length) ? (place.photos[0].getUrl({maxWidth: 400}) || '') : '';
Â  Â  Â  return {
Â  Â  Â  Â  place_id: place.place_id,
Â  Â  Â  Â  name: place.name,
Â  Â  Â  Â  vicinity: place.vicinity || place.formatted_address || '',
Â  Â  Â  Â  lat: place.geometry?.location?.lat(),
Â  Â  Â  Â  lng: place.geometry?.location?.lng(),
Â  Â  Â  Â  rating: place.rating || null,
Â  Â  Â  Â  photo
Â  Â  Â  };
Â  Â  }

Â  Â  // Render results list as a stack of cards
Â  Â  function renderResults(places) {
Â  Â  Â  currentResults = places;
Â  Â  Â  cardsWrap.innerHTML = '';
Â  Â  Â  if (!places || places.length === 0) {
Â  Â  Â  Â  cardsWrap.innerHTML = '<div class="empty-note">No results found.</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  places.forEach((p,i) => {
Â  Â  Â  Â  const cardNode = createCard(p, i);
Â  Â  Â  Â  // apply depth transform for stack
Â  Â  Â  Â  const c = cardNode.querySelector('.card');
Â  Â  Â  Â  c.style.transform = `scale(${1 - i*0.03}) translateY(${i*8}px)`;
Â  Â  Â  Â  cardsWrap.appendChild(cardNode);
Â  Â  Â  });
Â  Â  }

Â  Â  // Map initialization
Â  Â  function initMap() {
Â  Â  Â  console.log("Map initialized");
Â  Â  Â  const map = new google.maps.Map(document.getElementById("map"), {
Â  Â  Â  Â  center: { lat: 12.5029, lng: 124.6307 }, // Default: Catarman
Â  Â  Â  Â  zoom: 13,
Â  Â  Â  });
Â  Â  Â  window.map = map; // make map global
Â  Â  Â  mapStatus.textContent = "Map focused on Catarman (Test Location)";
Â  Â  Â  appInit();
Â  Â  }


Â  Â  function centerMapToPlace(place) {
Â  Â  Â  if (!map) return;
Â  Â  Â  const lat = place.geometry.location.lat();
Â  Â  Â  const lng = place.geometry.location.lng();
Â  Â  Â  map.panTo({lat, lng});
Â  Â  Â  map.setZoom(17);

Â  Â  Â  // open Google Maps link on button
Â  Â  Â  btnOpenGoogle.onclick = () => {
Â  Â  Â  Â  const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.place_id}`;
Â  Â  Â  Â  window.open(url, '_blank');
Â  Â  Â  };
Â  Â  Â  mapStatus.textContent = `${place.name}`;
Â  Â  Â  currentPlaceFocused = place;
Â  Â  }

Â  Â  // Render saved list inside modal
Â  Â  function renderSavedList() {
Â  Â  Â  const saved = getSaved();
Â  Â  Â  savedList.innerHTML = '';
Â  Â  Â  if (!saved.length) {
Â  Â  Â  Â  savedList.innerHTML = '<div class="empty-note">No saved shops yet.</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  saved.forEach(s => {
Â  Â  Â  Â  const el = document.createElement('div');
Â  Â  Â  Â  el.className = 'saved-row';
Â  Â  Â  Â  el.innerHTML = `
Â  Â  Â  Â  Â  <img src="${s.photo || 'https://placehold.co/80x80/DDC8BE/ffffff?text=Milktea'}" alt="${escapeHtml(s.name)}" onerror="this.onerror=null; this.src='https://placehold.co/80x80/DDC8BE/ffffff?text=Milktea';" />
Â  Â  Â  Â  Â  <div class="saved-meta">
Â  Â  Â  Â  Â  Â  <div class="saved-title">${escapeHtml(s.name)}</div>
Â  Â  Â  Â  Â  Â  <div class="saved-sub">${escapeHtml(s.vicinity || '')}</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="saved-actions">
Â  Â  Â  Â  Â  Â  <button class="btn btn-soft" data-open="${s.place_id}">Map</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" data-remove="${s.place_id}">âœ•</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  savedList.appendChild(el);

Â  Â  Â  Â  el.querySelector('[data-remove]').addEventListener('click', () => {
Â  Â  Â  Â  Â  removeSaved(s.place_id);
Â  Â  Â  Â  });
Â  Â  Â  Â  el.querySelector('[data-open]').addEventListener('click', () => {
Â  Â  Â  Â  Â  // pan map to saved marker if available
Â  Â  Â  Â  Â  if (s.lat && s.lng && map) {
Â  Â  Â  Â  Â  Â  map.panTo({lat: s.lat, lng: s.lng});
Â  Â  Â  Â  Â  Â  map.setZoom(16);
Â  Â  Â  Â  Â  Â  savedModal.classList.add('hidden'); // Close modal after selection
Â  Â  Â  Â  Â  Â  showToast(`Viewing ${s.name} on map`);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast('Coordinates unavailable for this saved item');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }

Â  Â  // Saved markers (on the map preview)
Â  Â  function renderSavedMarkers() {
Â  Â  Â  // Clear existing savedMarkers
Â  Â  Â  savedMarkers.forEach(m => m.setMap(null));
Â  Â  Â  savedMarkers = [];
Â  Â  Â  const saved = getSaved();
Â  Â  Â  saved.forEach(s => {
Â  Â  Â  Â  if (s.lat && s.lng && map) {
Â  Â  Â  Â  Â  const marker = new google.maps.Marker({
Â  Â  Â  Â  Â  Â  position: {lat: s.lat, lng: s.lng},
Â  Â  Â  Â  Â  Â  map,
Â  Â  Â  Â  Â  Â  title: s.name,
Â  Â  Â  Â  Â  Â  icon: {
Â  Â  Â  Â  Â  Â  Â  path: google.maps.SymbolPath.CIRCLE,
Â  Â  Â  Â  Â  Â  Â  scale: 7,
Â  Â  Â  Â  Â  Â  Â  fillColor: '#d6a77a', // Accent color for saved
Â  Â  Â  Â  Â  Â  Â  fillOpacity: 1,
Â  Â  Â  Â  Â  Â  Â  strokeColor: '#fff',
Â  Â  Â  Â  Â  Â  Â  strokeWeight: 1
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const inf = new google.maps.InfoWindow({content: `<strong>${escapeHtml(s.name)}</strong><div>${escapeHtml(s.vicinity)}</div>`});
Â  Â  Â  Â  Â  marker.addListener('click', () => inf.open(map, marker));
Â  Â  Â  Â  Â  savedMarkers.push(marker);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // Utility: compute distance from user to place, show in card meta
Â  Â  function updateDistanceDisplays(userLat, userLng) {
Â  Â  Â  currentResults.forEach(place => {
Â  Â  Â  Â  if (!place.geometry) return;
Â  Â  Â  Â  const lat = place.geometry.location.lat();
Â  Â  Â  Â  const lng = place.geometry.location.lng();
Â  Â  Â  Â  const d = haversine(userLat, userLng, lat, lng);
Â  Â  Â  Â  const el = document.getElementById(`d-${place.place_id}`);
Â  Â  Â  Â  if (el) el.textContent = `${Math.round(d)} m`;
Â  Â  Â  });
Â  Â  }

Â  Â  // Haversine meters
Â  Â  function haversine(lat1, lon1, lat2, lon2){
Â  Â  Â  const R = 6371000;
Â  Â  Â  const toRad = v => v * Math.PI / 180;
Â  Â  Â  const dLat = toRad(lat2 - lat1);
Â  Â  Â  const dLon = toRad(lon2 - lon1);
Â  Â  Â  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
Â  Â  Â  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
Â  Â  Â  return R * c;
Â  Â  }

Â  Â  // Escape HTML
Â  Â  function escapeHtml(s) {
Â  Â  Â  if (!s) return '';
Â  Â  Â  return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
Â  Â  }

Â  Â  // Places search using Google Maps PlacesService (client side)
Â  Â  function findNearbyByCoords(lat, lng, isGeolocated = false) {
Â  Â  Â  if (!map) {
Â  Â  Â  Â  showToast('Map not loaded yet');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  showLoader(true);
Â  Â  Â  const svc = new google.maps.places.PlacesService(map);
Â  Â  Â  const request = {
Â  Â  Â  Â  location: new google.maps.LatLng(lat, lng),
Â  Â  Â  Â  radius: SEARCH_RADIUS,
Â  Â  Â  Â  type: ['restaurant', 'cafe'], // broadening types slightly
Â  Â  Â  Â  keyword: 'milk tea boba bubble tapioca'
Â  Â  Â  };
Â  Â  Â  svc.nearbySearch(request, (results, status, pagination) => {
Â  Â  Â  Â  showLoader(false);
Â  Â  Â  Â  if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length) {
Â  Â  Â  Â  Â  // update currentResults and render cards
Â  Â  Â  Â  Â  renderResults(results);
Â  Â  Â  Â  Â  updateDistanceDisplays(lat, lng);
Â  Â  Â  Â  Â  // show markers for saved in map
Â  Â  Â  Â  Â  renderSavedMarkers();
Â  Â  Â  Â  Â  // set user marker
Â  Â  Â  Â  Â  if (userMarker) userMarker.setPosition({lat, lng});
Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  userMarker = new google.maps.Marker({
Â  Â  Â  Â  Â  Â  Â  position: { lat, lng },
Â  Â  Â  Â  Â  Â  Â  map,
Â  Â  Â  Â  Â  Â  Â  title: isGeolocated ? 'Your Location' : 'Test Location',
Â  Â  Â  Â  Â  Â  Â  icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: '#709475', fillOpacity: 1, strokeColor: '#fff', strokeWeight:1 }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  map.panTo({lat, lng});
Â  Â  Â  Â  Â  map.setZoom(14);
Â  Â  Â  Â  Â  mapStatus.textContent = isGeolocated ? `Results near you (${results.length})` : `Results near UEP/Catarman (${results.length})`;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Center map on first result if available
Â  Â  Â  Â  Â  if (results.length > 0) {
Â  Â  Â  Â  Â  Â  centerMapToPlace(results[0]);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
Â  Â  Â  Â  Â  renderResults([]);
Â  Â  Â  Â  Â  showToast('No results found in this radius');
Â  Â  Â  Â  Â  mapStatus.textContent = 'No results';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  console.error('PlacesService error', status);
Â  Â  Â  Â  Â  renderResults([]);
Â  Â  Â  Â  Â  showToast(`Places API error: ${status}. Check console for details.`);
Â  Â  Â  Â  Â  mapStatus.textContent = 'Error';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // Geolocation flows
Â  Â  function findBobaNearMe() {
Â  Â  Â  showLoader(true);
Â  Â  Â  if (!navigator.geolocation) {
Â  Â  Â  Â  showLoader(false);
Â  Â  Â  Â  showToast('Geolocation not available');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  navigator.geolocation.getCurrentPosition((pos) => {
Â  Â  Â  Â  const lat = pos.coords.latitude;
Â  Â  Â  Â  const lng = pos.coords.longitude;
Â  Â  Â  Â  findNearbyByCoords(lat, lng, true);
Â  Â  Â  }, (err) => {
Â  Â  Â  Â  showLoader(false);
Â  Â  Â  Â  console.error('Geolocation error', err);
Â  Â  Â  Â  showToast('Location denied or unavailable. Try the test mode.');
Â  Â  Â  }, { enableHighAccuracy: true, timeout: 10000 });
Â  Â  }

Â  Â  // Test Catarman coordinates (UEP)
Â  Â  function testCatarman() {
Â  Â  Â  const lat = 12.5029, lng = 124.6307;
Â  Â  Â  findNearbyByCoords(lat, lng, false);
Â  Â  }

Â  Â  // Buttons wiring
Â  Â  btnFind.addEventListener('click', () => { findBobaNearMe(); });
Â  Â  btnTest.addEventListener('click', () => { testCatarman(); });
Â  Â  btnSaved.addEventListener('click', () => {
Â  Â  Â  renderSavedList();
Â  Â  Â  savedModal.classList.remove('hidden');
Â  Â  });
Â  Â  savedClose.addEventListener('click', () => savedModal.classList.add('hidden'));
    
    // FIX: Replaced confirm() with direct action
Â  Â  savedClear.addEventListener('click', () => {
Â  Â  Â  clearSavedAll();
      savedModal.classList.add('hidden');
Â  Â  });
    // FIX: Replaced confirm() with direct action
Â  Â  btnClearSaved.addEventListener('click', () => {
Â  Â  Â  clearSavedAll();
Â  Â  });

Â  Â  btnLike.addEventListener('click', () => {
Â  Â  Â  // simulate swipe right on top card
Â  Â  Â  const top = document.querySelector('.card-wrapper');
Â  Â  Â  if (!top) { showToast('No card to like'); return; }
Â  Â  Â  top.querySelector('.card').style.transition = 'transform 300ms ease';
Â  Â  Â  top.querySelector('.card').style.transform = 'translateX(150%) rotate(12deg)';
Â  Â  Â  const place = currentResults[0];
Â  Â  Â  setTimeout(()=> { top.remove(); addSaved(serializePlaceForSaving(place)); rearrangeStack(); }, 250);
Â  Â  });

Â  Â  btnReject.addEventListener('click', () => {
Â  Â  Â  const top = document.querySelector('.card-wrapper');
Â  Â  Â  if (!top) { showToast('No card to reject'); return; }
Â  Â  Â  top.querySelector('.card').style.transition = 'transform 300ms ease';
Â  Â  Â  top.querySelector('.card').style.transform = 'translateX(-150%) rotate(-12deg)';
Â  Â  Â  setTimeout(()=> { top.remove(); rearrangeStack(); }, 250);
Â  Â  });

Â  Â  // init on load: render saved & init map if google maps script already loaded
Â  Â  window.appInit = function() {
Â  Â  Â  renderSavedList();
Â  Â  Â  renderSavedMarkers();
Â  Â  Â  showToast('Ready â€” use Find Boba Near Me');
Â  Â  };

Â  Â  // Expose functions for Google Maps callback
Â  Â  window.initMap = initMap;
Â  </script>

Â  <!--
Â  Â  Load Google Maps JS with Places library.
Â  -->
Â  <script async defer
Â  Â  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDk8cpELLpGngE-1uLEGSuG5VnUwTqPq3w&libraries=places&callback=initMap">
Â  </script>
</body>
</html>
