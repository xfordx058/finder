<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milktea Maven 🥤</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧋</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <style>
        :root {
            --primary-color: #A3C9A8; /* Soft Green */
            --secondary-color: #E2F0D9; /* Light Cream */
            --text-color: #333;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 400px;
        }
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #709475;
            margin-bottom: 8px;
        }
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap; /* Allows buttons to wrap on small screens */
            justify-content: center;
            margin-bottom: 24px;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: 2px solid var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #8bb190;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            background-color: #f0f0f0;
            color: #709475;
            border: 2px solid #ddd;
        }
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        /* Card Styling for Swiping */
        .cards-wrapper {
            position: relative;
            height: 400px; /* Fixed height for the stack */
            width: 100%;
            max-width: 350px;
            margin-top: 30px;
        }
        .swipe-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            touch-action: none; /* Allows HammerJS to handle touch */
            cursor: grab;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
        }
        .location-card {
            background-color: white;
            border-radius: 1rem;
            padding: 16px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            transform-origin: center;
            border: 1px solid #ddd;
        }
        .location-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 0.75rem;
            margin-bottom: 12px;
        }
        .saved-list-wrapper {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }
        .saved-card {
            display: flex;
            align-items: center;
            text-align: left;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background-color: white;
            border-radius: 0.5rem;
        }
        .saved-card img {
            width: 80px;
            height: 80px;
            margin-right: 16px;
            flex-shrink: 0;
            border-radius: 0.25rem;
        }
        .saved-card div {
            flex-grow: 1;
        }
        .saved-card button {
            background-color: #e57373;
            color: white;
            padding: 8px 12px;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.2s;
            margin-left: 12px;
        }
        .saved-card button:hover {
            background-color: #d32f2f;
        }
    </style>
    <script>
        // --- Core Application Configs ---
        
        // IMPORTANT: REPLACE THIS WITH YOUR ACTUAL, RESTRICTED GOOGLE PLACES API KEY
        const apiKey = "AIzaSyDk8cpELLpGngE-1uLEGSuG5VnUwTqPq3w"; 
        const API_ENDPOINT = "https://maps.googleapis.com/maps/api/place/nearbysearch/json";
        const PHOTO_ENDPOINT = "https://maps.googleapis.com/maps/api/place/photo";
        const LOCAL_STORAGE_KEY = 'milktea_maven_saved'; // Key for localStorage persistence

        /**
         * Helper to retrieve saved shops from localStorage.
         */
        function getSavedShops() {
            try {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                return savedData ? JSON.parse(savedData) : [];
            } catch (e) {
                console.error("Error reading localStorage:", e);
                return [];
            }
        }

        /**
         * Converts coordinates to a location string for the API.
         * @param {number} lat 
         * @param {number} lng 
         * @returns {string}
         */
        const getLocationString = (lat, lng) => `${lat},${lng}`;

        /**
         * Clears the card wrapper and displays a message.
         */
        function displayStatusMessage(message, isError = false) {
            const container = document.querySelector('.cards-wrapper');
            const color = isError ? 'text-red-500' : 'text-gray-500';
            container.innerHTML = `<p class="text-center ${color} text-sm font-medium">${message}</p>`;
        }

        /**
         * Fetches nearby Milktea shops using a specified location.
         */
        async function fetchMilkteaShops(lat, lng, locationName = "your location") {
            displayStatusMessage(`Searching for Milktea near ${locationName}...`);

            // Use 'restaurant' type + 'milktea|boba|bubble tea' keyword for best results
            const keyword = 'milktea|boba|bubble%20tea'; 
            // 5000 meters (5km) radius
            const endpoint = `${API_ENDPOINT}?location=${getLocationString(lat, lng)}&radius=5000&type=restaurant&keyword=${keyword}&key=${apiKey}`;

            try {
                const response = await fetch(endpoint);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("HTTP Error:", response.status, response.statusText, errorText);
                    displayStatusMessage(`Request failed: HTTP Status ${response.status}. Check console for API key or restriction issues.`, true);
                    return;
                }

                const data = await response.json();

                if (data.status !== "OK" && data.status !== "ZERO_RESULTS") {
                    console.error("Places API Status Error:", data.status, data.error_message || "");
                    // API Status can be REQUEST_DENIED if key is invalid/not enabled
                    let msg = `API Error: ${data.status}. Did you enable the Places API and use a valid key?`;
                    displayStatusMessage(msg, true);
                    return;
                }

                if (data.results && data.results.length > 0) {
                    displaySwipeCards(data.results);
                } else {
                    displayStatusMessage(`No Milktea shops found near ${locationName} 😢`);
                }
            } catch (e) {
                console.error("Network or Parsing Error:", e);
                displayStatusMessage('A network error occurred. Check your internet connection.', true);
            }
        }
        
        /**
         * TEST MODE: Fetches Milktea shops using a known boba hotspot (Manila, PH).
         */
        function fetchManilaTest() {
            // Coordinates for Intramuros/central Manila, Philippines
            const manilaLat = 14.5995;
            const manilaLng = 120.9842;
            fetchMilkteaShops(manilaLat, manilaLng, "Manila, Philippines");
        }


        /**
         * Fetches location via browser geolocation (no caching).
         */
        function getLocation() {
            displayStatusMessage('Locating you...');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    fetchMilkteaShops(lat, lng, "your current location");
                }, (err) => {
                    console.error("Geolocation Error:", err);
                    displayStatusMessage('Location access denied or unavailable. Please enable location services.', true);
                });
            } else {
                displayStatusMessage('Geolocation is not supported by your browser.', true);
            }
        }

        /**
         * Renders the swipeable cards.
         */
        function displaySwipeCards(shops) {
            const container = document.querySelector('.cards-wrapper');
            container.innerHTML = '';
            
            shops.forEach((shop, i) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'swipe-wrapper';
                wrapper.style.zIndex = 200 - i; // Stack cards
                wrapper.setAttribute('data-place-id', shop.place_id);

                // Simple card depth scaling
                const scale = 1 - (i * 0.05);
                const translateY = 10 * i;
                
                const card = document.createElement('div');
                card.className = 'location-card';
                card.style.transform = `scale(${scale}) translateY(${translateY}px)`;
                
                // Get photo URL or use a placeholder
                const photoRef = shop.photos?.[0]?.photo_reference;
                const imgUrl = photoRef 
                    ? `${PHOTO_ENDPOINT}?maxwidth=400&photoreference=${photoRef}&key=${apiKey}`
                    : 'https://placehold.co/400x180/A3C9A8/ffffff?text=Milktea+Shop';
                
                const shopData = {
                    id: shop.place_id, 
                    name: shop.name,
                    place_id: shop.place_id,
                    photo: imgUrl,
                    rating: shop.rating || 'N/A'
                };

                card.innerHTML = `
                    <img src="${imgUrl}" onerror="this.onerror=null; this.src='https://placehold.co/400x180/A3C9A8/ffffff?text=Milktea+Shop';" alt="${shop.name}" class="shadow-md" />
                    <h3 class="text-xl font-bold text-gray-800 mb-1">${shop.name}</h3>
                    <p class="text-lg text-yellow-600">⭐️ ${shop.rating || 'No Rating'}</p>
                    <p class="text-sm text-gray-400 mt-2">Swipe right to save 💖</p>
                `;

                wrapper.appendChild(card);
                container.appendChild(wrapper);

                setupSwipeListeners(wrapper, shopData);
            });
        }

        /**
         * Initializes HammerJS for swiping on a card.
         */
        function setupSwipeListeners(wrapper, shopData) {
            const hammertime = new Hammer(wrapper);
            const card = wrapper.querySelector('.location-card');

            // Pan/Drag listener for interactive movement
            hammertime.on('pan move', (e) => {
                if (e.deltaX !== 0) {
                    const rotation = e.deltaX / 50; // Rotate based on drag
                    card.style.transition = 'none';
                    card.style.transform = `translate(${e.deltaX}px, 0px) rotate(${rotation}deg)`;
                }
            });

            // Pan End listener to determine swipe direction or reset
            hammertime.on('panend', (e) => {
                card.style.transition = 'transform 0.3s ease';

                if (e.deltaX > 100) { // Swipe Right (Save)
                    saveAndDismiss(wrapper, shopData, 'right');
                } else if (e.deltaX < -100) { // Swipe Left (Reject)
                    dismissCard(wrapper, 'left');
                } else { // Reset
                    resetCard(wrapper);
                }
            });
        }

        /**
         * Resets a card to its default position.
         */
        function resetCard(wrapper) {
            const card = wrapper.querySelector('.location-card');
            const index = Array.from(wrapper.parentNode.children).indexOf(wrapper);
            const scale = 1 - (index * 0.05);
            const translateY = 10 * index;
            card.style.transform = `scale(${scale}) translateY(${translateY}px)`;
        }


        /**
         * Saves the shop (via localStorage) and dismisses the card.
         */
        function saveAndDismiss(wrapper, shopData, direction) {
            saveShop(shopData);
            wrapper.style.transition = 'transform 0.3s, opacity 0.3s';
            const offset = direction === 'right' ? '150%' : '-150%';
            const rotation = direction === 'right' ? '15deg' : '-15deg';
            wrapper.style.transform = `translateX(${offset}) rotate(${rotation})`;
            wrapper.style.opacity = 0;
            setTimeout(() => wrapper.remove(), 300);
            updateCardStack();
        }

        /**
         * Dismisses the card without saving.
         */
        function dismissCard(wrapper, direction) {
            wrapper.style.transition = 'transform 0.3s, opacity 0.3s';
            const offset = direction === 'right' ? '150%' : '-150%';
            const rotation = direction === 'right' ? '15deg' : '-15deg';
            wrapper.style.transform = `translateX(${offset}) rotate(${rotation})`;
            wrapper.style.opacity = 0;
            setTimeout(() => wrapper.remove(), 300);
            updateCardStack();
        }

        /**
         * Function to re-style remaining cards after a swipe.
         */
        function updateCardStack() {
            // Apply slight delay to ensure element removal is processed
            setTimeout(() => {
                const remainingCards = document.querySelectorAll('.cards-wrapper .swipe-wrapper');
                remainingCards.forEach((wrapper, index) => {
                    const card = wrapper.querySelector('.location-card');
                    const scale = 1 - (index * 0.05);
                    const translateY = 10 * index;
                    
                    wrapper.style.zIndex = 200 - index;
                    card.style.transition = 'transform 0.3s ease';
                    card.style.transform = `scale(${scale}) translateY(${translateY}px)`;
                });
            }, 50);
        }

        /**
         * Saves a shop to localStorage.
         */
        function saveShop(shop) {
            try {
                const saved = getSavedShops();
                // Check if shop already exists (to prevent duplicates)
                if (!saved.some(s => s.place_id === shop.place_id)) {
                    saved.push(shop);
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(saved));
                    displayStatusMessage(`'${shop.name}' saved to your collection!`, false);
                } else {
                    displayStatusMessage(`'${shop.name}' is already saved!`, false);
                }
                setTimeout(() => updateCardStack(), 1500); 
            } catch (e) {
                console.error("Error saving shop to localStorage:", e);
                displayStatusMessage(`Failed to save '${shop.name}'. Check console.`, true);
            }
        }


        /**
         * Displays the list of saved shops from localStorage.
         */
        function showSaved() {
            const container = document.querySelector('.cards-wrapper');
            container.innerHTML = `<p class="text-center text-gray-500 font-semibold">Loading saved shops...</p>`;
            
            const saved = getSavedShops();

            // Clear and render
            container.innerHTML = '';
            const savedList = document.createElement('div');
            savedList.className = 'saved-list-wrapper';

            if (saved.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">You haven\'t saved any Milktea shops yet! 😢</p>';
                return;
            }

            saved.forEach(shop => {
                const card = document.createElement('div');
                card.className = 'location-card saved-card';
                card.innerHTML = `
                    <img src="${shop.photo}" onerror="this.onerror=null; this.src='https://placehold.co/80x80/A3C9A8/ffffff?text=Milktea';" alt="${shop.name}" class="shadow-sm" />
                    <div>
                        <h3 class="font-semibold">${shop.name}</h3>
                        <p class="text-sm text-yellow-600">⭐️ ${shop.rating}</p>
                    </div>
                    <button class="remove-btn" onclick="removeSavedShop('${shop.place_id}')">Remove</button>
                `;
                savedList.appendChild(card);
            });
            container.appendChild(savedList);
        }
        
        /**
         * Removes a saved shop from localStorage.
         */
        function removeSavedShop(placeId) {
            try {
                let saved = getSavedShops();
                const updatedSaved = saved.filter(shop => shop.place_id !== placeId);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(updatedSaved));
                
                // Re-render the saved list immediately
                showSaved();
            } catch (e) {
                console.error("Error removing shop from localStorage:", e);
                displayStatusMessage(`Failed to remove shop. Check console.`, true);
            }
        }

        // Initialize the status message when the page loads
        window.onload = () => {
             displayStatusMessage('Ready! Click "Find Boba Near Me" or "Test with Manila".');
        }
    </script>
</head>
<body class="p-4">
    <div class="container">
        <header class="header">
            <h1 class="text-4xl font-extrabold text-[#709475]">Milktea Maven 🧋</h1>
            <p class="text-sm text-gray-600">Swipe right to save your next boba fix! (Radius: 5km)</p>
        </header>

        <div class="button-group">
            <!-- Renamed function to getLocation() and removed disabled -->
            <button class="btn btn-primary" id="findBobaBtn" onclick="getLocation()">Find Boba Near Me</button>
            <button class="btn btn-primary" id="showSavedBtn" onclick="showSaved()">Show My Saved Boba</button>
            <button class="btn btn-secondary" id="testManilaBtn" onclick="fetchManilaTest()">Test with Manila (PH Hotspot)</button>
        </div>

        <!-- Card Swiping Area -->
        <div class="cards-wrapper" style="margin-top: 30px;">
            <p class="text-center text-gray-500 font-semibold">Initializing app...</p>
        </div>
    </div>
</body>
</html>
